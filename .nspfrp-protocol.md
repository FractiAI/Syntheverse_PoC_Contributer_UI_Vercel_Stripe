# NSPFRP Protocol: Automatic Bug Prevention System

**Natural System Protocol First Refactoring Pattern**  
**Purpose:** Prevent fractalized self-similar logic errors through protocol enforcement

---

## Core Principle

**Before adding new code that extracts scores or toggles:**
1. ✅ Check if `ScoreExtractor` or `ToggleExtractor` utilities exist
2. ✅ Use centralized utilities instead of inline logic
3. ✅ If pattern doesn't exist in utilities, ADD IT FIRST, then use it
4. ❌ NEVER copy-paste score/toggle extraction logic

---

## Protocol Rules (Automated Checks)

### Rule 1: Score Extraction
**FORBIDDEN PATTERNS:**
```typescript
// ❌ FORBIDDEN: Direct pod_score access
const score = data.pod_score ?? data.metadata?.pod_score ?? 0;

// ❌ FORBIDDEN: Inline atomic_score extraction
const score = data.atomic_score?.final ?? data.score_trace?.final_score ?? data.pod_score ?? 0;

// ❌ FORBIDDEN: Multiple fallback chains
const score = submission.pod_score || metadata.pod_score || evaluation.pod_score || 0;
```

**REQUIRED PATTERN:**
```typescript
// ✅ REQUIRED: Use centralized extractor
import { extractSovereignScore, formatSovereignScore } from '@/utils/thalet/ScoreExtractor';
const score = extractSovereignScore(data);
const display = formatSovereignScore(score, '—');
```

### Rule 2: Toggle Extraction
**FORBIDDEN PATTERNS:**
```typescript
// ❌ FORBIDDEN: Inline toggle checks
seedMultiplierEnabled = configValue.seed_enabled === true;
edgeMultiplierEnabled = configValue.edge_enabled === true;

// ❌ FORBIDDEN: Inconsistent checks
seedMultiplierEnabled = configValue.seed_enabled !== false; // Wrong!
```

**REQUIRED PATTERN:**
```typescript
// ✅ REQUIRED: Use centralized extractor
import { extractToggleStates } from '@/utils/thalet/ToggleExtractor';
const toggles = extractToggleStates(configValue);
seedMultiplierEnabled = toggles.seedMultiplierEnabled;
```

### Rule 3: Score Display
**FORBIDDEN PATTERNS:**
```typescript
// ❌ FORBIDDEN: Direct pod_score display
{data.pod_score?.toLocaleString() || 'N/A'}

// ❌ FORBIDDEN: Inline extraction in JSX
{data.atomic_score?.final ?? data.pod_score ?? 0}
```

**REQUIRED PATTERN:**
```typescript
// ✅ REQUIRED: Use formatSovereignScore
{formatSovereignScore(extractSovereignScore(data), '—')}
```

---

## Automated Enforcement

### Pre-Commit Hook
Checks for forbidden patterns before commit:
- Detects direct `pod_score` access
- Detects inline `atomic_score` extraction
- Detects inline toggle extraction
- Suggests using centralized utilities

### Linting Rules
ESLint rules to catch violations:
- `no-direct-pod-score-access`
- `no-inline-score-extraction`
- `no-inline-toggle-extraction`
- `require-sovereign-score-extractor`

### CI/CD Checks
Automated tests verify:
- All score displays use `extractSovereignScore()`
- All toggle reads use `extractToggleStates()`
- No duplicate extraction logic exists

---

## Protocol Benefits

1. **Prevents Fractalization:** Single source of truth enforced by protocol
2. **Automatic Bug Prevention:** Catches violations before commit
3. **Self-Documenting:** Protocol rules document correct patterns
4. **Systematic:** Same pattern everywhere, no variations
5. **Maintainable:** Fix bugs in one place, not 15+

---

## Violation Response

When protocol violation detected:
1. **Block commit** (pre-commit hook)
2. **Show error message** with correct pattern
3. **Suggest fix** using centralized utility
4. **Link to documentation** for reference

---

**Status:** Protocol established. Automated enforcement pending implementation.

